# SimplePay Payment Processing System

## Overview

SimplePay is a robust payment processing system built in Go, designed to work with multiple payment providers. Each provider may have different response formats and error structures. The system is highly extensible, allowing new providers to be integrated easily while maintaining high performance and reliability.

## Terminology

### Order
An **order** represents a request for payment made by a merchant.  
It is the **basic unit** that identifies a transaction before payment is processed.

**Key attributes:**
- `ID`: Unique identifier for the order.
- `MerchantID`: The merchant who created this order.
- `Amount`, `Currency`: Payment details.
- `Status`: Tracks whether the order is `created`, `completed`, etc.

**Purpose:** You cannot process a payment without an associated order. Each order is unique and can be paid only once.

---

### Terminal
A **terminal** links a **merchant** to a **provider**.

**Key attributes:**
- `ID`: Unique identifier for the terminal.
- `MerchantID`: Merchant assigned to this terminal.
- `ProviderID`: Payment provider associated with this terminal.

**Purpose:** When a merchant creates a payment, the terminal determines **which provider handles the transaction**. This allows your system to support multiple providers dynamically.

---

### Merchant
Represents a business or individual using your payment system.

**Key attributes:**
- `ID`: Unique identifier.
- `Name`: Merchant’s name.
- `Secret / Key`: Used for authentication (Basic Auth) when creating orders or payments.

**Purpose:** Merchants are the entities creating orders and payments.

---

### Payment
Represents the **actual transaction** processed through a payment provider.

**Key attributes:**
- `ID`: Unique payment identifier.
- `OrderID`: The order this payment corresponds to.
- `MerchantID`: Merchant making the payment.
- `ProviderID`: Provider processing the payment.
- `Amount`, `Currency`, `Status`

**Purpose:** After an order is created, a payment is executed through a provider. Only orders with `created` status can be paid.

---

### Provider
External service that actually processes payments (like Provider A or Provider B in your system).

**Purpose:** Each provider has its own API and response format. The **factory pattern** in your system handles these differences and normalizes the responses.

---

## Features

- Onboard new merchants with automatic key and terminal generation.
- Process orders and payments with strict validations:
   - Basic auth per merchant.
   - Each order ID can be used only once.
   - No merchant can pay orders generated by other merchants.
- Factory pattern used to normalize provider responses and handle provider-specific behavior.
- Singleton pattern used to initialize services and database connections.
- Structured service-repo architecture:
   - Each folder contains its own repository file for database operations.
   - Services are initialized in `boot.go` and registered in a singleton registry.
- Payment providers are dynamically associated with merchants via terminals.
- Comprehensive error handling for invalid requests, failed payments, and edge cases.

## Architecture

- **Service Layer:** Business logic for merchants, orders, payments, and terminals.
- **Repository Layer:** Handles all database interactions.
- **Factory Pattern:** Normalizes and validates provider responses at runtime.
- **Singleton Pattern:** Ensures only one instance of each service and database client exists.
- **Database:** MySQL (SQL port 3306) using GORM and native SQL queries.

## Running the Application

- Clone the repository
- Create a `.env` file in the project root:
```env
DATABASE_URL=simplepay_user:12345678@tcp(127.0.0.1:3306)/simplepay?charset=utf8mb4&parseTime=True&loc=Local
PORT=8080
```
- Install MySQL and run it on port 3306
- In the root directory ( ./ ), run go mod tidy
- Create a mysql user simplepay_user and give access like INSERT, CREATE, UPDATE, GRANT, INDEX etc.
- Create a database simplepay
- Run the app by executing following command
```env
go run cmd/main.go
```

## Adding a New Payment Provider

To extend SimplePay with a new payment provider, follow these steps:

### 1. Create a Provider Folder
Inside the `providerfactory` folder, create a new folder for your provider:


### 2. Implement `service.go`
Create a `service.go` file inside the new provider folder. Implement:
- Logic to send the payment request to the provider’s API.
- Parsing of **provider-specific success and error responses**.
- Normalization of the response to the internal `PaymentModel`.

Example structure:
```go
type ProviderCService struct {}

func (p *ProviderCService) ProcessPayment(payment *PaymentModel) (*PaymentModel, error) {
    // 1. Send request to provider API
    // 2. Parse response (success or error)
    // 3. Normalize response to PaymentModel
    // 4. Return updated PaymentModel or error
}
```

## Example API Calls

### Create a Provider
```bash
curl --location 'http://localhost:8080/provider' \
--header 'Content-Type: application/json' \
--data '{
   "name": "provider_a"
}'
```

### Create a Merchant
```bash
curl --location 'http://localhost:8080/merchants' \
--header 'Content-Type: application/json' \
--data '{
    "name": "Indigo Air Private Limited",
    "category":"travel",
    "status": "activated"
}'
```

Note: Basic Auth header can be formed by encoding base 64 merchant id and its secret, For example, if the merchant id  is **8fd2b4bda1** and key obtained while creating merchant is **7eac3d2142** ===> **8fd2b4bda1:7eac3d2142** ==base64==> **OGZkMmI0YmRhMTo3ZWFjM2QyMTQy** is the basic auth

### Create a Order
```bash
curl --location 'http://localhost:8080/orders' \
--header 'Content-Type: application/json' \
--header 'Authorization: Basic OGZkMmI0YmRhMTo3ZWFjM2QyMTQy' \
--data '{
    "amount":1,
    "currency":"USD",
    "order_details":"something something",
    "merchant_id":"8fd2b4bda1"
}'
```

### Create a Payment
```bash
curl --location 'http://localhost:8080/payments' \
--header 'Content-Type: application/json' \
--header 'Authorization: Basic OGZkMmI0YmRhMTo3ZWFjM2QyMTQy' \
--data '{
    "amount":1,
    "currency":"USD",
    "merchant_id":"8fd2b4bda1",
    "order_id":"1fe700e7c5",
    "forced_provider":"975cb0a457"
}'
```

## Additional Features to Build

1. **Dynamic Currency Handling**
  - Currently, the system supports a fixed currency per payment.
  - Future improvement: allow multiple currencies, handle conversions, and ensure proper validations for cross-currency payments.

2. **Terminal Prioritization Across Providers**
  - Each merchant can have multiple terminals, one per provider.
  - Implement a preference-based sorting algorithm to select the optimal terminal for a payment request.

3. **Asynchronous Reconciliation and Settlement Flows**
  - Introduce background jobs to handle:
    - Payment reconciliation across multiple providers.
    - Settlement flows for completed transactions.
  - This will improve scalability and reduce blocking during payment processing.



